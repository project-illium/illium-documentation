"use strict";(self.webpackChunkillium_documentation=self.webpackChunkillium_documentation||[]).push([[8916],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var r=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=r.createContext({}),c=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},p=function(e){var t=c(e.components);return r.createElement(s.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=c(n),m=o,h=d["".concat(s,".").concat(m)]||d[m]||u[m]||i;return n?r.createElement(h,a(a({ref:t},p),{},{components:n})):r.createElement(h,a({ref:t},p))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,a=new Array(i);a[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[d]="string"==typeof e?e:o,a[1]=l;for(var c=2;c<i;c++)a[c]=n[c];return r.createElement.apply(null,a)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},6207:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>a,default:()=>u,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var r=n(7462),o=(n(7294),n(3905));const i={sidebar_position:3},a="Consensus Protocol",l={unversionedId:"protocol/consensus",id:"protocol/consensus",title:"Consensus Protocol",description:"The consensus protocol implements the avalanche consensus algorithm.",source:"@site/docs/protocol/consensus.md",sourceDirName:"protocol",slug:"/protocol/consensus",permalink:"/protocol/consensus",draft:!1,editUrl:"https://github.com/project-illium/illium-documentation/docs/protocol/consensus.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"specSidebar",previous:{title:"Libp2p",permalink:"/protocol/libp2p"},next:{title:"Chain Service Protocol",permalink:"/protocol/chain-service"}},s={},c=[{value:"Protocol ID",id:"protocol-id",level:3},{value:"Network Messages",id:"network-messages",level:3},{value:"Protocol",id:"protocol",level:3}],p={toc:c},d="wrapper";function u(e){let{components:t,...n}=e;return(0,o.kt)(d,(0,r.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"consensus-protocol"},"Consensus Protocol"),(0,o.kt)("p",null,"The consensus protocol implements the avalanche consensus algorithm."),(0,o.kt)("h3",{id:"protocol-id"},"Protocol ID"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},"/ilx/<network>/consensus/1.0.0\n")),(0,o.kt)("p",null,"Where ",(0,o.kt)("inlineCode",{parentName:"p"},"<network>")," is either ",(0,o.kt)("inlineCode",{parentName:"p"},"mainnet"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"testnet"),", or ",(0,o.kt)("inlineCode",{parentName:"p"},"regtest")," depending on which\nnetwork is being used."),(0,o.kt)("h3",{id:"network-messages"},"Network Messages"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},"enum ErrorResponse {\n    None       = 0;\n    NotFound   = 1;\n    BadRequest = 2;\n    NotCurrent = 3;\n}\n\nmessage MsgConsensusRequest {\n    oneof msg {\n        MsgPollRequest poll_request = 1;\n        GetBlockReq get_block = 2;\n    }\n}\n\nmessage MsgPollRequest {\n    uint32 request_ID       = 1;\n    repeated uint32 heights = 2;\n}\n\nmessage MsgPollResponse {\n    uint32 request_ID    = 1;\n    repeated bytes votes = 2;\n}\n\nmessage GetBlockReq {\n    bytes block_ID = 1;\n}\n\nmessage MsgBlockResp {\n    Block block         = 1;\n    ErrorResponse error = 2;\n}\n\n")),(0,o.kt)("h3",{id:"protocol"},"Protocol"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"When a new block comes off the wire a node checks it against its local policy. If the block passes the local policy\ncheck then it is marked as ",(0,o.kt)("inlineCode",{parentName:"li"},"Acceptable"),", otherwise ",(0,o.kt)("inlineCode",{parentName:"li"},"Unacceptable"),"."),(0,o.kt)("li",{parentName:"ol"},"If an ",(0,o.kt)("inlineCode",{parentName:"li"},"Acceptable")," block gets passed into the consensus engine it is assigned a preference of ",(0,o.kt)("inlineCode",{parentName:"li"},"Preferred")," if there are no\nother preferred blocks. ",(0,o.kt)("inlineCode",{parentName:"li"},"Unacceptable")," blocks start as ",(0,o.kt)("inlineCode",{parentName:"li"},"NotPreferred"),"."),(0,o.kt)("li",{parentName:"ol"},"If a new block conflicts (same height) with another block that is ",(0,o.kt)("inlineCode",{parentName:"li"},"Preferred")," the new block preference is set to ",(0,o.kt)("inlineCode",{parentName:"li"},"Not Preferred"),"."),(0,o.kt)("li",{parentName:"ol"},"Once per millisecond the consensus engine select a random peer to query from the validator set, weighted by the percentage of\ntotal stake that validator has, and sends a ",(0,o.kt)("inlineCode",{parentName:"li"},"MsgAvaRequest")," to that peer requesting a vote on a block height. The peer responds\nwith the ID of the block it prefers at that height."),(0,o.kt)("li",{parentName:"ol"},"We rate limit the number of inflight requests go out at any one time to the number of responses remaining needed to finalize the block.\nIf the next 1 millisecond step occurs before any of the outstanding requests return, the step is skipped."),(0,o.kt)("li",{parentName:"ol"},"When the ",(0,o.kt)("inlineCode",{parentName:"li"},"MsgAvaResponse")," returns the votes are processed. ",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"We record a ",(0,o.kt)("inlineCode",{parentName:"li"},"Yes")," vote for the block ID in the response and a ",(0,o.kt)("inlineCode",{parentName:"li"},"No")," vote for all other block IDs."),(0,o.kt)("li",{parentName:"ul"},"If ",(0,o.kt)("inlineCode",{parentName:"li"},">12")," out of the last ",(0,o.kt)("inlineCode",{parentName:"li"},"16")," recorded votes for a block are ",(0,o.kt)("inlineCode",{parentName:"li"},"Yes")," then we consider the vote conclusive."),(0,o.kt)("li",{parentName:"ul"},"If ",(0,o.kt)("inlineCode",{parentName:"li"},">12")," out of the last ",(0,o.kt)("inlineCode",{parentName:"li"},"16")," recorded votes for a block are ",(0,o.kt)("inlineCode",{parentName:"li"},"No")," then we consider the vote conclusive."),(0,o.kt)("li",{parentName:"ul"},"Unknown or unacceptable votes (zero ID) ",(0,o.kt)("em",{parentName:"li"},"are")," included in the last 16 votes. They will prevent a block vote from being conclusive\nif there are enough of them."),(0,o.kt)("li",{parentName:"ul"},"If the vote is conclusive, and it agrees with our current state, either ",(0,o.kt)("inlineCode",{parentName:"li"},"Preferred")," or ",(0,o.kt)("inlineCode",{parentName:"li"},"Not Preferred"),", then we\nincrement a confidence counter by 1.",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"If the confidence counter is >= ",(0,o.kt)("inlineCode",{parentName:"li"},"160")," and the current state is ",(0,o.kt)("inlineCode",{parentName:"li"},"Preferred"),", then we mark the block as ",(0,o.kt)("inlineCode",{parentName:"li"},"Finalized")," and\nmark all conflicting blocks as ",(0,o.kt)("inlineCode",{parentName:"li"},"Rejected"),"."),(0,o.kt)("li",{parentName:"ul"},"If the confidence counter is >= ",(0,o.kt)("inlineCode",{parentName:"li"},"160")," and the current state is ",(0,o.kt)("inlineCode",{parentName:"li"},"Not Preferred"),", then we do nothing. Eventually a\nconflicting block will finalize resulting in this one being marked as ",(0,o.kt)("inlineCode",{parentName:"li"},"Rejected"),"."))),(0,o.kt)("li",{parentName:"ul"},"If the vote is conclusive, and it does not agree with our current state, either ",(0,o.kt)("inlineCode",{parentName:"li"},"Preferred")," or ",(0,o.kt)("inlineCode",{parentName:"li"},"Not Preferred"),", then\nwe flip our current preference and reset our confidence counter to zero. ",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"If the preference flipped from ",(0,o.kt)("inlineCode",{parentName:"li"},"Not Preferred")," to ",(0,o.kt)("inlineCode",{parentName:"li"},"Preferred")," then all conflicting blocks must also flip to ",(0,o.kt)("inlineCode",{parentName:"li"},"NotPreferred"),"\nby virtue of the same number of ",(0,o.kt)("inlineCode",{parentName:"li"},"No")," votes having been cast for them."),(0,o.kt)("li",{parentName:"ul"},"If the preference flipped from ",(0,o.kt)("inlineCode",{parentName:"li"},"Preferred")," to ",(0,o.kt)("inlineCode",{parentName:"li"},"NotPreferred")," and we have no other preferred blocks. We selected a\nnew ",(0,o.kt)("inlineCode",{parentName:"li"},"Preferred")," block from the list of ",(0,o.kt)("inlineCode",{parentName:"li"},"Acceptable")," blocks. If no blocks are ",(0,o.kt)("inlineCode",{parentName:"li"},"Acceptable")," then have no preference and\nrespond to ",(0,o.kt)("inlineCode",{parentName:"li"},"MsgAvaRequest"),"s with a zero ID."))))),(0,o.kt)("li",{parentName:"ol"},"Simultaneously we work to finalize the leading bits of the block ID. ",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"We start with the most significant bit (MSB). When a block ID vote is recorded we examine the MSB of the block ID.",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"If the MSB is a 0 we record a ",(0,o.kt)("inlineCode",{parentName:"li"},"Zero")," vote for the MSB."),(0,o.kt)("li",{parentName:"ul"},"If the MSB is a 1 we record a ",(0,o.kt)("inlineCode",{parentName:"li"},"One")," vote for the MSB."),(0,o.kt)("li",{parentName:"ul"},"Unknown or unacceptable votes (zero ID)  ",(0,o.kt)("em",{parentName:"li"},"are")," included in the last 16 votes. They will prevent a bit vote from being conclusive\nif there are enough of them."),(0,o.kt)("li",{parentName:"ul"},"If ",(0,o.kt)("inlineCode",{parentName:"li"},">12")," out of the last ",(0,o.kt)("inlineCode",{parentName:"li"},"16")," bit votes are the same we consider the vote conclusive.",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"We increment the confidence counter for that bit."),(0,o.kt)("li",{parentName:"ul"},"If the current ",(0,o.kt)("inlineCode",{parentName:"li"},"Preferred")," block does not start with the same MSB we flip our preference to a different block\nthat does match the preferred MSB."))),(0,o.kt)("li",{parentName:"ul"},"If the confidence counter is >= ",(0,o.kt)("inlineCode",{parentName:"li"},"160")," we consider the MSB finalized and repeat the process for the remaining bits.")))))),(0,o.kt)("p",null,"In situations where there are more than two conflicting blocks at the same height, the bit finalization helps to coordinate\npreferences by reducing the candidate set until a block eventually finalizes."))}u.isMDXComponent=!0}}]);